<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Home Page V1 Terminal</title>
  <link href="./app.css" rel="stylesheet"/>
</head>
<body>
<header class="dxtl-header">
  <img class="logo" src="logo.svg" alt="DXLT"/>
  <div class="status"><span class="pulse-dot"></span>Live Terminal</div>
</header>

<div class="app">
  <aside class="nav-rail">
    <div class="brand">
      <svg aria-hidden="true" class="brand-icon" viewBox="0 0 48 48">
        <defs>
          <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
            <stop offset="0" stop-color="#60A5FA" />
            <stop offset="1" stop-color="#22D3EE" />
          </linearGradient>
        </defs>
        <circle cx="24" cy="24" r="20" fill="url(#g)" opacity=".25"></circle>
        <circle cx="24" cy="24" r="19" fill="none" stroke="url(#g)" stroke-width="2" opacity=".6"></circle>
        <polygon points="21,17 33,24 21,31" fill="url(#g)"></polygon>
      </svg>
      <span class="brand-text">XLT</span>
    </div>

    <nav class="nav-group">
      <button class="nav-btn" data-route="home"><span class="i">üè†</span><span class="t">Home</span></button>
      <button class="nav-btn" data-route="pulse"><span class="i">üìà</span><span class="t">Pulse</span></button>
      <button class="nav-btn" data-route="dex"><span class="i">üîÑ</span><span class="t">Dex</span></button>
      <button class="nav-btn" data-route="wealth"><span class="i">üíº</span><span class="t">Wealth</span></button>
      <button class="nav-btn active" data-route="bots"><span class="i">ü§ñ</span><span class="t">Bot Army</span></button>
      <button class="nav-btn" data-route="market"><span class="i">üõí</span><span class="t">Market Place</span></button>
      <button class="nav-btn" data-route="learn"><span class="i">üéì</span><span class="t">Learn Zone</span></button>
    </nav>

    <div class="nav-spacer"></div>
    <nav class="nav-group">
      <button class="nav-btn" data-route="settings"><span class="i">‚öôÔ∏è</span><span class="t">Settings</span></button>
      <button class="nav-btn" data-route="login"><span class="i">üîí</span><span class="t">User Login</span></button>
      <button class="nav-btn" data-route="mt"><span class="i">üìä</span><span class="t">MT4/MT5 Account</span></button>
    </nav>
  </aside>

  <main class="main">
    <div class="topbar">
      <span class="badge left">Live Mode</span>
      <div class="topbar-title">Pulse</div>
      <div class="spacer"></div>
      <div class="wallet" id="wallet-open">
        <span>üëõ</span><strong id="wallet-status">Disconnected</strong>
      </div>
    </div>

    <div class="content pulse-wrap">
      <!-- Controls -->
      <section class="card pulse-controls">
        <div class="search-wrap">
          <span class="search-ico" title="Search asset">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <circle cx="11" cy="11" r="7" fill="none" stroke="currentColor" stroke-width="2"/>
              <line x1="16.5" y1="16.5" x2="21" y2="21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </span>
          <input id="pulseSearch" type="text" placeholder="Search asset (e.g., BTCUSDT)" list="suggestList" autocomplete="off"/>
          <datalist id="suggestList"></datalist>
          <button class="btn" id="pulseSet" type="button">Set</button>
        </div>
        <div class="now-playing">
          <button class="icon-btn" id="soundBtn" title="Toggle sound" type="button">
            <svg viewBox="0 0 24 24" class="ico-sound"><path d="M4 9h4l4-3v12l-4-3H4z" fill="currentColor"/><path d="M16 8a5 5 0 010 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            <svg viewBox="0 0 24 24" class="ico-mute"><path d="M4 9h4l4-3v12l-4-3H4z" fill="currentColor"/><path d="M17 7l4 4m0-4l-4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
          <span class="chip">Symbol: <strong id="pulseSymbol">‚Äî</strong></span>
          <span class="chip bpm">BPM: <strong id="pulseBpm">‚Äî</strong></span>
          <span class="chip">State: <strong id="pulseState">‚Äî</strong></span>
          <span class="chip">Price: <strong id="pdPrice">‚Äî</strong></span>
        </div>
      </section>

      <!-- Heart monitor -->
      <section class="card pulse-hero">
        <canvas id="pulseCanvas"></canvas>
        <div class="pulse-overlay"><div class="ecg-glow"></div></div>
      </section>

      <!-- Info panel -->
      <section class="card pulse-data">
        <header class="pd-head">
          <div class="pd-title">
            <div class="dot live"></div>
            <div>
              <h3 id="pdSymbol">‚Äî</h3>
              <div class="muted" id="pdSubtitle">Select an asset to load insights.</div>
            </div>
          </div>
          <div class="pd-badges">
            <span class="chip" id="pdTrend">Trend: ‚Äî</span>
            <span class="chip" id="pdRegime">Regime: ‚Äî</span>
            <span class="chip" id="pdRisk">Risk: ‚Äî</span>
          </div>
        </header>

        <div class="pd-grid">
          <div class="pd-col">
            <div class="pd-card">
              <h4>About</h4>
              <p class="muted" id="pdAbout">‚Äî</p>
              <div class="meta">
                <span>Age: <strong id="pdAge">‚Äî</strong></span>
                <span>Exchange: <strong id="pdVenue">‚Äî</strong></span>
              </div>
            </div>

            <div class="pd-card">
              <h4>Runs</h4>
              <ul class="list">
                <li>Last Bull Run: <strong id="pdLastBull">‚Äî</strong></li>
                <li>Next Run ETA: <strong id="pdNextRun">‚Äî</strong></li>
              </ul>
            </div>

            <div class="pd-card">
              <h4>Signals</h4>
              <ul class="list">
                <li>General Trend: <strong id="pdGeneralTrend">‚Äî</strong></li>
                <li>Momentum: <strong id="pdMomentum">‚Äî</strong></li>
                <li>Volatility: <strong id="pdVol">‚Äî</strong></li>
              </ul>
            </div>
          </div>

          <div class="pd-col charts">
            <div class="mini-chart">
              <canvas id="sparkPrice"></canvas>
              <div class="mini-label">Price Spark</div>
            </div>
            <div class="mini-chart">
              <canvas id="sparkVol"></canvas>
              <div class="mini-label">Volatility Spark</div>
            </div>
            <div class="mini-chart wide">
              <canvas id="sparkTrend"></canvas>
              <div class="mini-label">Trend Slope</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Market Depth -->
      <section class="card depth-card" id="depthCard">
        <div class="mini-head">
          <span>Market Depth</span>
          <span class="mini-sub muted">Top 25 levels ¬∑ live</span>
          <span id="depthVenue" class="mini-sub muted" style="margin-left:.5rem"></span>
        </div>
        <div class="gauge-row">
          <canvas id="depthGauge"></canvas>
          <div class="labels">
            <div class="bid">Bids <strong id="depthBid">‚Äî%</strong></div>
            <div class="ask">Asks <strong id="depthAsk">‚Äî%</strong></div>
          </div>
        </div>
        <canvas id="depthSpark" style="margin-top:.5rem;width:540px;max-width:100%;height:44px"></canvas>
      </section>
    </div>

    <!-- Positions & Liquidity -->
    <section class="card pulse-positions" id="positionsPanel">
      <div class="pp-head">
        <div class="title">Positions & Liquidity</div>
        <div class="segrow small" id="ppTf">
          <button class="seg on" data-min="5">5m</button>
          <button class="seg" data-min="15">15m</button>
          <button class="seg" data-min="60">1h</button>
        </div>
      </div>
      <div class="pp-grid">
        <div class="pp-col stats">
          <div class="gauge">
            <canvas id="ppGauge"></canvas>
            <div class="gauge-label">
              <div><span class="long">Long</span> <strong id="ppLong">‚Äî%</strong></div>
              <div><span class="short">Short</span> <strong id="ppShort">‚Äî%</strong></div>
              <div class="muted" id="ppBias">Bias: ‚Äî</div>
            </div>
          </div>
        </div>
        <div class="pp-col zones">
          <div class="zone-card">
            <div class="zone-head">Nearest Liquidity ‚Äî <span class="long">Long</span></div>
            <div class="heat-wrap">
              <canvas id="ppLongHeat"></canvas>
              <div class="heat-legend"><span class="muted">Below</span> <span id="ppLongPrice">‚Äî</span></div>
            </div>
          </div>
          <div class="zone-card">
            <div class="zone-head">Nearest Liquidity ‚Äî <span class="short">Short</span></div>
            <div class="heat-wrap">
              <canvas id="ppShortHeat"></canvas>
              <div class="heat-legend"><span class="muted">Above</span> <span id="ppShortPrice">‚Äî</span></div>
            </div>
          </div>
        </div>
      </div>
      <div class="pp-foot muted">Source: CoinGecko market data ¬∑ Timeframe: <span id="ppTfLabel">5m</span></div>
    </section>

    <!-- Top 20 -->
    <section class="card pulse-top" id="top20">
      <div class="top-head">
        <div class="title">Top 20 ‚Äî Market</div>
        <div class="segrow small" id="topMode">
          <button class="seg on" data-mode="mcap">Mkt Cap</button>
          <button class="seg" data-mode="movers1h">Movers 1h</button>
          <button class="seg" data-mode="movers24h">Movers 24h</button>
        </div>
        <div class="hint muted">Click an asset to set it as the Pulse symbol.</div>
      </div>
      <div class="asset-grid" id="assetGrid"></div>
    </section>
  </main>
</div>

<div class="modal-backdrop" id="wallet-modal" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <span class="close-x" id="wallet-close" role="button" tabindex="0" aria-label="Close">‚úï</span>
    <h4>Connect Wallet</h4>
    <p style="color:#94a3b8;margin:0 0 8px 0">Choose a wallet:</p>
    <div class="row">
      <button class="btn full" data-wallet="MetaMask">MetaMask</button>
      <button class="btn full" data-wallet="WalletConnect">WalletConnect</button>
    </div>
    <div class="row">
      <button class="btn" onclick="DXLT.disconnect()">Disconnect</button>
      <button class="btn primary" onclick="document.getElementById('wallet-close').click()">Close</button>
    </div>
  </div>
</div>

<footer>DXLT Neon v1.0</footer>

<script src="./feeds.js"></script>
<!-- Optional: include a tiny shim if your API routes differ
<script src="/js/pulse-compat.js"></script>
-->

<!-- Routes -->
<script>
(() => {
  const routes = {
    home:'index.html', pulse:'pulse.html', dex:'dex.html', wealth:'wealth.html',
    bots:'bots.html', market:'market.html', learn:'learn.html',
    settings:'settings.html', login:'login.html', mt:'mt.html'
  };
  document.querySelectorAll('.nav-btn[data-route]').forEach(btn => {
    btn.addEventListener('click', () => {
      const r = btn.getAttribute('data-route');
      if (routes[r]) window.location.href = routes[r];
    });
  });
})();
</script>

<!-- Search: suggestions + resolve + broadcast -->
<script>
(() => {
  const input = document.getElementById('pulseSearch');
  const list  = document.getElementById('suggestList');
  const setBtn= document.getElementById('pulseSet');
  const chip  = document.getElementById('pulseSymbol');

  let t=null; const debounce=(fn,ms=150)=>{clearTimeout(t);t=setTimeout(fn,ms);};

  async function loadSuggestions(q){
    if (!list) return;
    try{
      const r = await fetch(`/api/symbols?q=${encodeURIComponent(q||'')}`, { cache:'no-store' });
      const j = await r.json();
      list.innerHTML='';
      (j.items||[]).forEach(it=>{
        const opt=document.createElement('option');
        opt.value = it.symbol;
        opt.label = `${it.base}/${it.quote} ‚Äî ${(it.venues||[]).join('/')}`;
        opt.textContent = opt.label;
        list.appendChild(opt);
      });
    }catch(_){}
  }
  if (input){
    input.addEventListener('input', ()=>debounce(()=>loadSuggestions(input.value),120));
    input.addEventListener('focus', ()=>{ if(!list.options.length) loadSuggestions(''); });
  }

  async function setSymbol(q){
    if (!q) return;
    try{
      const r = await fetch(`/api/resolve?q=${encodeURIComponent(q)}&cb=${Date.now()}`, { cache:'no-store' });
      const j = await r.json();
      const sym = (j.symbol || q).toUpperCase();
      chip.textContent = sym;
      window.CURRENT = Object.assign({}, window.CURRENT, { symbol: sym });
      window.dispatchEvent(new CustomEvent('dxlt:set-symbol', { detail: { symbol: sym }}));
    }catch(_){
      const sym = q.toUpperCase();
      chip.textContent = sym;
      window.CURRENT = Object.assign({}, window.CURRENT, { symbol: sym });
      window.dispatchEvent(new CustomEvent('dxlt:set-symbol', { detail: { symbol: sym }}));
    }
  }
  setBtn?.addEventListener('click', ()=> setSymbol(input.value.trim()));
  input?.addEventListener('keydown',(e)=>{ if(e.key==='Enter') setSymbol(input.value.trim()); });
})();
</script>

<!-- PULSE LIVE (ECG + sparks) -->
<script>
(() => {
  const $ = (s) => document.querySelector(s);

  const chipSym   = $('#pulseSymbol');
  const chipBpm   = $('#pulseBpm');
  const chipState = $('#pulseState');
  const priceEl   = $('#pdPrice');
  const titleSym  = $('#pdSymbol');
  const subEl     = $('#pdSubtitle');
  const trendEl   = $('#pdTrend');
  const regimeEl  = $('#pdRegime');
  const riskEl    = $('#pdRisk');

  const cECG = $('#pulseCanvas');
  const cSP  = $('#sparkPrice');
  const cSV  = $('#sparkVol');
  const cST  = $('#sparkTrend');

  const S = { symbol:'BTCUSDT', priceSpark:[], volSpark:[], trendSpark:[], maxSpark:80, bpm:80, state:'steady' };

  const getSymbol = () => {
    const chip = chipSym?.textContent.trim();
    if (chip && chip !== '‚Äî') return chip.toUpperCase();
    if (window.CURRENT?.symbol) return String(window.CURRENT.symbol).toUpperCase();
    return S.symbol;
  };
  const baseFromPair = (sym) => {
    const m = String(sym).toUpperCase().match(/^([A-Z0-9]+?)(USDT|USD|EUR|GBP|BTC|ETH)$/);
    return (m ? m[1] : sym).toLowerCase();
  };

  async function fetchTop(){
    const r = await fetch('/api/cg/top?limit=250', { cache:'no-store' });
    if(!r.ok) throw new Error('cg/top '+r.status);
    return r.json();
  }
  const pickCoin = (list, baseLower) =>
    list.find(c => (c.symbol||'').toLowerCase()===baseLower) ||
    list.find(c => (c.name||'').toLowerCase().startsWith(baseLower)) || null;

  const fmt = (n,dp=2)=> (n==null||!isFinite(n)) ? '‚Äî' : Number(n).toLocaleString(
    undefined,{minimumFractionDigits:dp,maximumFractionDigits:dp});
  const badgeTrend=(p1h,p24h)=> p1h>0.8&&p24h>1?'UP':(p1h<-0.8&&p24h<-1?'DOWN':'SIDE');
  const badgeRegime=(v)=> v>4?'HIGH VOL':v>2?'MED VOL':'LOW VOL';
  const badgeRisk=(p24,vol)=> (Math.abs(p24)*.6+vol*.4)>=8?'ELEVATED':(Math.abs(p24)*.6+vol*.4)>=4?'MODERATE':'CALM';

  function setBadges(coin){
    const p1h  = coin.price_change_percentage_1h_in_currency ?? 0;
    the24h:
    const p24h = coin.price_change_percentage_24h_in_currency ?? 0;
    const vol  = Math.abs(p1h)*1.2 + Math.abs(p24h)*0.5;

    trendEl && (trendEl.textContent = `Trend: ${badgeTrend(p1h,p24h)}`);
    regimeEl && (regimeEl.textContent = `Regime: ${badgeRegime(vol)}`);
    riskEl   && (riskEl.textContent   = `Risk: ${badgeRisk(p24h,vol)}`);

    const bpm = Math.max(55, Math.min(170, 70 + p24h*2 + vol*2));
    S.bpm = bpm;
    S.state = (p24h>1.5?'surge':(p24h<-1.5?'stress':'steady'));
    chipBpm   && (chipBpm.textContent   = Math.round(bpm));
    chipState && (chipState.textContent = S.state.toUpperCase());
  }

  function updateInfo(coin, sym){
    titleSym && (titleSym.textContent = sym);
    subEl    && (subEl.textContent    = coin.name ? `${coin.name} ‚Äî rank #${coin.market_cap_rank}` : '‚Äî');
    priceEl  && (priceEl.textContent  = coin.current_price!=null ? `$${fmt(coin.current_price,2)}` : '‚Äî');
  }

  function sizeCanvas(cv,w,h){
    const dpr=window.devicePixelRatio||1;
    cv.width=Math.floor(w*dpr); cv.height=Math.floor(h*dpr);
    cv.style.width=w+'px'; cv.style.height=h+'px';
    const ctx=cv.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0); return ctx;
  }
  function drawSpark(cv, vals, color='#22d3ee'){
    if(!cv||vals.length<2) return;
    const W=Math.max(cv.clientWidth||180,160), H=Math.max(cv.clientHeight||60,48), ctx=sizeCanvas(cv,W,H);
    ctx.clearRect(0,0,W,H);
    const min=Math.min(...vals), max=Math.max(...vals), pad=6, span=(max-min)||1;
    ctx.strokeStyle='rgba(148,163,184,.12)'; ctx.beginPath(); ctx.moveTo(pad,H-1.5); ctx.lineTo(W-pad,H-1.5); ctx.stroke();
    ctx.lineWidth=2; ctx.strokeStyle=color; ctx.beginPath();
    vals.forEach((v,i)=>{const x=pad+(W-2*pad)*(i/(vals.length-1)); const y=H-pad-(H-2*pad)*((v-min)/span); i?ctx.lineTo(x,y):ctx.moveTo(x,y);});
    ctx.stroke();
  }

  const ECG=(()=>{let t0=0,raf=0;
    function draw(cv,bpm,mode='steady'){
      const W=cv.clientWidth||880,H=Math.max(cv.clientHeight||220,160),ctx=sizeCanvas(cv,W,H);
      ctx.clearRect(0,0,W,H);
      const mid=H*.6,msPer=60000/Math.max(40,Math.min(200,bpm)),now=performance.now(); if(!t0)t0=now;
      const phase=((now-t0)%msPer)/msPer;
      ctx.strokeStyle='rgba(34,211,238,.15)';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(0,mid);ctx.lineTo(W,mid);ctx.stroke();
      ctx.strokeStyle='#22d3ee';ctx.lineWidth=2;ctx.beginPath();
      const spikes=mode==='surge'?2:mode==='stress'?0.5:1;
      for(let x=0;x<=W;x++){const p=(phase+x/W)%1;const beat= p<.08?0 : p<.12?(p-.1)*-900 : p<.16?(p-.14)*900 : Math.sin((p-.16)*Math.PI*2*spikes)*.2;
        const amp=mode==='stress'?26:mode==='surge'?34:30; const y=mid-beat*amp; x?ctx.lineTo(x,y):ctx.moveTo(x,y);}
      ctx.stroke();
    }
    function loop(cv,bpmFn,modeFn){
      cancelAnimationFrame(raf);
      const tick=()=>{draw(cv,bpmFn(),modeFn());raf=requestAnimationFrame(tick)};
      raf=requestAnimationFrame(tick);
    }
    return{loop};
  })();

  async function tick(){
    const sym = getSymbol(), base = baseFromPair(sym);
    try{
      const top = await fetchTop();
      const coin = pickCoin(top, base);
      if(!coin) throw new Error('coin not found for '+sym);

      const price = Number(coin.current_price)||0;
      const vol   = Math.abs(Number(coin.price_change_percentage_24h_in_currency)||0);
      const trend = Number(coin.price_change_percentage_1h_in_currency)||0;

      S.priceSpark.push(price); S.volSpark.push(vol); S.trendSpark.push(trend);
      if(S.priceSpark.length>S.maxSpark) S.priceSpark.shift();
      if(S.volSpark.length  >S.maxSpark) S.volSpark.shift();
      if(S.trendSpark.length>S.maxSpark) S.trendSpark.shift();

      updateInfo(coin, sym); setBadges(coin);
      drawSpark(cSP,S.priceSpark,'#22d3ee'); drawSpark(cSV,S.volSpark,'#a78bfa'); drawSpark(cST,S.trendSpark,'#34d399');

      if (chipSym && chipSym.textContent.trim()==='‚Äî') chipSym.textContent=sym;
    }catch(e){ console.warn('pulse-live tick error', e); }
  }

  window.addEventListener('dxlt:set-symbol', tick);
  cECG && ECG.loop(cECG, ()=>S.bpm, ()=>S.state);

  document.addEventListener('DOMContentLoaded', ()=>{
    if (chipSym && chipSym.textContent.trim()!=='‚Äî') S.symbol = chipSym.textContent.trim().toUpperCase();
    tick(); setInterval(tick,15000);
  });
})();
</script>

<!-- Depth wiring -->
<script id="depth-wire">
(() => {
  const $  = (s) => document.querySelector(s);
  const bidEl   = $('#depthBid');
  const askEl   = $('#depthAsk');
  const venueEl = $('#depthVenue');
  const gaugeCv = $('#depthGauge');
  const sparkCv = $('#depthSpark');

  const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
  const hist = [];
  const HIST_N = 20;

  function getSymbol(){
    const t = document.getElementById('pulseSymbol')?.textContent.trim();
    if (t && t !== '‚Äî') return t.toUpperCase();
    if (window.CURRENT?.symbol) return String(window.CURRENT.symbol).toUpperCase();
    const ht = document.getElementById('pdSymbol')?.textContent.trim();
    return (ht && ht !== '‚Äî') ? ht.toUpperCase() : 'BTCUSDT';
  }

  function sizeCanvas(cv, w, h){
    const dpr = window.devicePixelRatio || 1;
    cv.width  = Math.floor(w * dpr);
    cv.height = Math.floor(h * dpr);
    cv.style.width  = w + 'px';
    cv.style.height = h + 'px';
    const ctx = cv.getContext('2d');
    ctx.setTransform(dpr,0,0,dpr,0,0);
    return ctx;
  }

  function drawGauge(cv, bidPct){
    const ctx = sizeCanvas(cv, 380, 140);
    const W = 380, H = 140;
    const cx = W/2, cy = H-10;
    const R  = Math.min(W*0.42, H*0.9);

    ctx.lineWidth = 10;

    ctx.strokeStyle = 'rgba(148,163,184,0.22)';
    ctx.beginPath(); ctx.arc(cx,cy,R,Math.PI,0,false); ctx.stroke();

    const a = Math.max(0,Math.min(100,bidPct))/100 * Math.PI;
    const green = ctx.createLinearGradient(0,0,W,0);
    green.addColorStop(0,'#16a34a'); green.addColorStop(1,'#22d3ee');
    ctx.strokeStyle = green; ctx.beginPath();
    ctx.arc(cx,cy,R,Math.PI,Math.PI+a,false); ctx.stroke();

    const red = ctx.createLinearGradient(W,0,0,0);
    red.addColorStop(0,'#ef4444'); red.addColorStop(1,'#f59e0b');
    ctx.strokeStyle = red; ctx.beginPath();
    ctx.arc(cx,cy,R,Math.PI+a,0,false); ctx.stroke();

    const ang = (bidPct/100)*Math.PI - Math.PI/2;
    const nx = cx + Math.cos(Math.PI + ang) * (R-6);
    const ny = cy + Math.sin(Math.PI + ang) * (R-6);
    ctx.strokeStyle = '#e2e8f0'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(nx,ny); ctx.stroke();
    ctx.fillStyle = '#94a3b8'; ctx.beginPath(); ctx.arc(cx,cy,4,0,2*Math.PI); ctx.fill();
  }

  function drawSpark(cv, arr){
    const W = Math.max(cv.clientWidth||540, 320);
    const H = 44;
    const ctx = sizeCanvas(cv, W, H);
    ctx.clearRect(0,0,W,H);
    if (!arr.length) return;

    const step = W / Math.max(1, arr.length-1);
    ctx.strokeStyle='rgba(148,163,184,.12)';
    ctx.beginPath(); ctx.moveTo(0,H-1.5); ctx.lineTo(W,H-1.5); ctx.stroke();

    ctx.strokeStyle='#22d3ee'; ctx.lineWidth=2;
    ctx.beginPath();
    for (let i=0;i<arr.length;i++){
      const x = i*step;
      const y = H - (arr[i]/100) * (H-4) - 2;
      i?ctx.lineTo(x,y):ctx.moveTo(x,y);
    }
    ctx.stroke();

    ctx.strokeStyle='rgba(34,211,238,.35)'; ctx.lineWidth=6; ctx.stroke();
  }

  async function loadDepth(sym){
    try{
      const url = `/api/depth?symbol=${encodeURIComponent(sym)}&limit=50&levels=25&venue=smart&tz=${encodeURIComponent(tz)}&cb=${Date.now()}`;
      const r = await fetch(url, { cache: 'no-store' });
      const j = await r.json();

      const bid = Number.isFinite(j.bidPct) ? j.bidPct : 0;
      const ask = Number.isFinite(j.askPct) ? j.askPct : 0;

      bidEl && (bidEl.textContent = `${bid.toFixed(0)}%`);
      askEl && (askEl.textContent = `${ask.toFixed(0)}%`);
      venueEl && (venueEl.textContent = `‚Ä¢ ${sym} ‚Ä¢ source: ${j.venue || '‚Äî'} ‚Ä¢ ${tz}`);

      gaugeCv && drawGauge(gaugeCv, bid);

      hist.push(bid); while (hist.length > HIST_N) hist.shift();
      sparkCv && drawSpark(sparkCv, hist);
    }catch(e){ console.warn('depth fetch error', e); }
  }

  const tick = ()=> loadDepth((()=>{
    const t=document.getElementById('pulseSymbol')?.textContent.trim();
    if(t&&t!=='‚Äî') return t.toUpperCase();
    return window.CURRENT?.symbol?.toUpperCase() || 'BTCUSDT';
  })());
  document.addEventListener('DOMContentLoaded', ()=>{ tick(); setInterval(tick,15000); });
  window.addEventListener('dxlt:set-symbol', tick);

  const symNode = document.getElementById('pulseSymbol');
  if (symNode && 'MutationObserver' in window){
    const mo = new MutationObserver(()=>tick());
    mo.observe(symNode, { childList:true, characterData:true, subtree:true });
  }
})();
</script>

<!-- Positions & Liquidity -->
<script id="positions-wire">
(() => {
  const $ = (s) => document.querySelector(s);

  // UI elements
  const gaugeCv    = $('#ppGauge');
  const longLbl    = $('#ppLong');
  const shortLbl   = $('#ppShort');
  const biasLbl    = $('#ppBias');
  const longHeatCv = $('#ppLongHeat');
  const shortHeatCv= $('#ppShortHeat');
  const longPrice  = $('#ppLongPrice');
  const shortPrice = $('#ppShortPrice');
  const tfWrap     = $('#ppTf');
  const tfOut      = $('#ppTfLabel');

  let tfMin = 5;

  tfWrap?.addEventListener('click', (e) => {
    const b = e.target.closest('button.seg');
    if (!b) return;
    tfWrap.querySelectorAll('button.seg').forEach(x => x.classList.toggle('on', x === b));
    tfMin = +b.dataset.min || 5;
    tfOut && (tfOut.textContent = (tfMin === 60 ? '1h' : `${tfMin}m`));
    tick(); // refresh immediately
  });

  const currentSymbol = () => {
    const chip = document.getElementById('pulseSymbol')?.textContent.trim();
    if (chip && chip !== '‚Äî') return chip.toUpperCase();
    if (window.CURRENT?.symbol) return String(window.CURRENT.symbol).toUpperCase();
    return 'BTCUSDT';
  };

  function sizeCanvas(cv, w, h){
    const dpr = window.devicePixelRatio || 1;
    cv.width  = Math.floor(w * dpr);
    cv.height = Math.floor(h * dpr);
    cv.style.width = w + 'px'; cv.style.height = h + 'px';
    const ctx = cv.getContext('2d');
    ctx.setTransform(dpr,0,0,dpr,0,0);
    return ctx;
  }

  function drawDonut(cv, longPct){
    if (!cv) return;
    const W = Math.max(cv.clientWidth || 420, 320);
    const H = Math.max(cv.clientHeight || 220, 160);
    const R = Math.min(W, H) * 0.36;
    const cx = W*0.4, cy = H*0.58;

    const ctx = sizeCanvas(cv, W, H);
    ctx.clearRect(0,0,W,H);

    // ring bg
    ctx.lineWidth = 16;
    ctx.strokeStyle = 'rgba(148,163,184,.18)';
    ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.stroke();

    // long arc
    const theta = Math.max(0, Math.min(100, longPct)) / 100 * Math.PI * 2;
    const gradG = ctx.createLinearGradient(cx-R,0,cx+R,0);
    gradG.addColorStop(0,'#16a34a'); gradG.addColorStop(1,'#22d3ee');
    ctx.strokeStyle = gradG;
    ctx.beginPath(); ctx.arc(cx,cy,R,-Math.PI/2,-Math.PI/2 + theta,false); ctx.stroke();

    // short arc
    const gradR = ctx.createLinearGradient(cx+R,0,cx-R,0);
    gradR.addColorStop(0,'#ef4444'); gradR.addColorStop(1,'#f59e0b');
    ctx.strokeStyle = gradR;
    ctx.beginPath(); ctx.arc(cx,cy,R,-Math.PI/2 + theta,-Math.PI/2 + Math.PI*2,false); ctx.stroke();

    // center dot
    ctx.fillStyle = '#94a3b8';
    ctx.beginPath(); ctx.arc(cx,cy,3,0,Math.PI*2); ctx.fill();
  }

  function drawHeatmap(cv, levels, last, side){
    if (!cv || !levels?.length) return;
    const W = Math.max(cv.clientWidth || 860, 400);
    const H = Math.max(cv.clientHeight || 200, 120);
    const ctx = sizeCanvas(cv, W, H);
    ctx.clearRect(0,0,W,H);

    const filtered = side === 'long'
      ? levels.filter(([p]) => p < last).sort((a,b)=>b[0]-a[0])
      : levels.filter(([p]) => p > last).sort((a,b)=>a[0]-b[0]);

    if (!filtered.length) return;

    const maxSize = Math.max(...filtered.map(l => l[1])) || 1;
    const pad = 10;
    const rowH = (H - pad*2) / Math.min(filtered.length, 40);
    const colW = W - pad*2;

    filtered.slice(0, 40).forEach((lv, i) => {
      const [, size] = lv;
      const x = pad, y = pad + i*rowH + 2;
      const k = Math.pow(size / maxSize, 0.6);
      const col = side === 'long'
        ? `rgba(34,197,94,${0.15 + 0.65*k})`
        : `rgba(239,68,68,${0.15 + 0.65*k})`;
      ctx.fillStyle = col;
      ctx.fillRect(x, y, colW * k, rowH - 4);
    });

    ctx.strokeStyle = 'rgba(148,163,184,.14)';
    ctx.beginPath(); ctx.moveTo(pad, H-1.5); ctx.lineTo(W-pad, H-1.5); ctx.stroke();
  }

  function nearestLiquidity(levels, last, side){
    const pool = side === 'long'
      ? levels.filter(([p]) => p < last)
      : levels.filter(([p]) => p > last);
    if (!pool.length) return null;
    const scored = pool.map(([p, s]) => ({ p, score: s / (1 + Math.abs(p-last)) }));
    scored.sort((a,b) => b.score - a.score);
    return scored[0].p;
  }

  async function fetchBook(sym){
    const r = await fetch(`/api/depth?symbol=${encodeURIComponent(sym)}&levels=80&limit=120&venue=smart&full=1&cb=${Date.now()}`, { cache:'no-store' });
    if (!r.ok) throw new Error('depth '+r.status);
    return r.json();
  }

  async function tick(){
    const sym = currentSymbol();
    try{
      const book = await fetchBook(sym);
      const longPct  = Number(book.bidPct) || 0;
      const shortPct = Number(book.askPct) || 0;
      const last     = Number(book.last) || (book.bids?.[0]?.[0] + book.asks?.[0]?.[0])/2;

      drawDonut(gaugeCv, longPct);
      longLbl  && (longLbl.textContent  = `${longPct.toFixed(0)}%`);
      shortLbl && (shortLbl.textContent = `${shortPct.toFixed(0)}%`);
      biasLbl  && (biasLbl.textContent  = longPct>shortPct ? 'Long' : longPct<shortPct ? 'Short' : 'Neutral');

      if (book.bids && book.asks){
        drawHeatmap(longHeatCv,  book.bids, last, 'long');
        drawHeatmap(shortHeatCv, book.asks, last, 'short');
        const nLong  = nearestLiquidity(book.bids, last, 'long');
        const nShort = nearestLiquidity(book.asks, last, 'short');
        longPrice  && (longPrice.textContent  = nLong  ? nLong.toLocaleString()  : '‚Äî');
        shortPrice && (shortPrice.textContent = nShort ? nShort.toLocaleString() : '‚Äî');
      }
    }catch(e){ console.warn('positions-wire', e); }
  }

  document.addEventListener('DOMContentLoaded', ()=>{ tfOut && (tfOut.textContent = (tfMin===60?'1h':`${tfMin}m`)); tick(); setInterval(tick, 12000); });
  window.addEventListener('dxlt:set-symbol', tick);

  const symNode = document.getElementById('pulseSymbol');
  if (symNode && 'MutationObserver' in window){
    const mo = new MutationObserver(()=>tick());
    mo.observe(symNode, { childList:true, characterData:true, subtree:true });
  }
})();
</script>

<!-- Top 20 wiring (mcap / movers 1h / movers 24h) -->
<script id="top20-wire">
(() => {
  const grid   = document.getElementById('assetGrid');
  const modeUI = document.getElementById('topMode');
  if (!grid || !modeUI) return;

  let mode = 'mcap';
  let cache = { time: 0, items: [] };

  const fmt = (n, dp=2) => (n==null||!isFinite(n)) ? '‚Äî' :
    Number(n).toLocaleString(undefined, { minimumFractionDigits: dp, maximumFractionDigits: dp });

  async function fetchTop(limit = 250) {
    if (Date.now() - cache.time < 15000 && cache.items.length) return cache.items;
    const r = await fetch(`/api/cg/top?limit=${limit}`, { cache: 'no-store' });
    const j = await r.json();
    cache = { time: Date.now(), items: Array.isArray(j) ? j : [] };
    return cache.items;
  }

  function pickList(items, mode) {
    const safeNum = (v, d=0) => Number.isFinite(Number(v)) ? Number(v) : d;
    if (mode === 'mcap') {
      return [...items]
        .filter(x => x.market_cap_rank != null)
        .sort((a,b) => a.market_cap_rank - b.market_cap_rank)
        .slice(0, 20);
    }
    if (mode === 'movers1h') {
      return [...items]
        .map(x => ({...x, mover: Math.abs(safeNum(x.price_change_percentage_1h_in_currency))}))
        .sort((a,b) => b.mover - a.mover)
        .slice(0, 20);
    }
    return [...items]
      .map(x => ({...x, mover: Math.abs(safeNum(x.price_change_percentage_24h_in_currency))}))
      .sort((a,b) => b.mover - a.mover)
      .slice(0, 20);
  }

  function symbolFor(x) {
    const base = String(x.symbol || x.name || '').toUpperCase().replace(/[^A-Z0-9]/g,'');
    return (base ? base : 'BTC') + 'USDT';
  }

  function changeBadge(pct) {
    if (!Number.isFinite(pct)) return '‚Äî';
    const s = pct >= 0 ? '+' : '';
    return `${s}${fmt(pct, 2)}%`;
  }

  function render(items) {
    grid.innerHTML = '';
    items.forEach(x => {
      const sym  = symbolFor(x);
      const price= x.current_price != null ? `$${fmt(x.current_price, 2)}` : '‚Äî';
      const p1h  = Number(x.price_change_percentage_1h_in_currency);
      const p24h = Number(x.price_change_percentage_24h_in_currency);
      const green = (v) => Number.isFinite(v) && v > 0;

      const card = document.createElement('button');
      card.className = 'asset-card';
      card.type = 'button';
      card.dataset.symbol = sym;
      card.innerHTML = `
        <div class="row">
          <div class="left">
            <div class="sym">${(x.symbol || x.name || '').toUpperCase()}</div>
            <div class="name muted">#${x.market_cap_rank ?? '‚Äî'} ${x.name ?? ''}</div>
          </div>
          <div class="right">
            <div class="price">${price}</div>
            <div class="changes">
              <span class="chip ${green(p1h)?'up':'down'}">${changeBadge(p1h)}</span>
              <span class="chip ${green(p24h)?'up':'down'}">${changeBadge(p24h)}</span>
            </div>
          </div>
        </div>`;
      card.addEventListener('click', () => {
        const chip = document.getElementById('pulseSymbol');
        if (chip) chip.textContent = sym;
        window.CURRENT = Object.assign({}, window.CURRENT, { symbol: sym });
        window.dispatchEvent(new CustomEvent('dxlt:set-symbol', { detail: { symbol: sym }}));
        const el = document.querySelector('.pulse-wrap');
        el?.scrollIntoView?.({ behavior:'smooth', block:'start' });
      });
      grid.appendChild(card);
    });
  }

  async function refresh() {
    try {
      const all = await fetchTop(250);
      const top = pickList(all, mode);
      render(top);
    } catch (e) {
      console.warn('top20 refresh error', e);
      grid.innerHTML = `<div class="muted" style="padding:8px">Top list unavailable.</div>`;
    }
  }

  modeUI.addEventListener('click', (e) => {
    const b = e.target.closest('button.seg');
    if (!b) return;
    modeUI.querySelectorAll('button.seg').forEach(x => x.classList.toggle('on', x === b));
    mode = String(b.dataset.mode || 'mcap');
    refresh();
  });

  document.addEventListener('DOMContentLoaded', () => {
    refresh();
    setInterval(refresh, 20000);
  });
})();
</script>

<!-- (Optional) If you still need other site-wide code, include them once -->
<script src="./bots.js"></script>
<script src="./pulse.js"></script>
</body>
</html>
