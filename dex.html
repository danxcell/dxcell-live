<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DXLT Â· Dex</title>

  <!-- Keep your old app.css in place (if you have it).
       This new file is fully scoped and safe. -->
  <link href="./dex.css" rel="stylesheet" />
</head>
<body class="dex-page">
  <!-- Topbar kept super light / scoped -->
  <header class="dex-topbar">
    <div class="left">
      <span class="badge">Live Mode</span>
      <h1>Dex</h1>
    </div>
    <div class="wallet" id="wallet-open">
      <span>ðŸ‘›</span><strong id="wallet-status">Disconnected</strong>
    </div>
  </header>

  <main class="dex-main">
    <!-- SCOUT / FILTERS -->
    <section class="card scout">
      <div class="chip-row chains" id="chains">
        <button class="chip on" data-chain="all">All</button>
        <button class="chip" data-chain="solana">Solana</button>
        <button class="chip" data-chain="ethereum">Ethereum</button>
        <button class="chip" data-chain="bsc">BSC</button>
        <button class="chip" data-chain="base">Base</button>
        <button class="chip" data-chain="arbitrum">Arbitrum</button>
        <button class="chip" data-chain="optimism">Optimism</button>
        <button class="chip" data-chain="polygon">Polygon</button>
      </div>

      <div class="chip-row sentiment" id="sentiment">
        <button class="chip on" data-mode="gainers">Gainers</button>
        <button class="chip" data-mode="losers">Losers</button>
        <button class="chip" data-mode="new">New &lt; 24h</button>
        <button class="chip" data-mode="hot">Hot TXNs</button>
      </div>

      <div class="filters">
        <label class="pill">
          <span>Vol (24h) â‰¥</span>
          <select id="fVol">
            <option value="0">$0</option>
            <option value="50000">$50k</option>
            <option value="100000" selected>$100k</option>
            <option value="250000">$250k</option>
            <option value="1000000">$1m</option>
          </select>
        </label>

        <label class="pill">
          <span>Liquidity â‰¥</span>
          <select id="fLiq">
            <option value="0">$0</option>
            <option value="50000">$50k</option>
            <option value="100000" selected>$100k</option>
            <option value="250000">$250k</option>
            <option value="1000000">$1m</option>
          </select>
        </label>

        <label class="pill">
          <span>Market Cap â‰¥</span>
          <select id="fCap">
            <option value="0">$0</option>
            <option value="250000">$250k</option>
            <option value="500000" selected>$500k</option>
            <option value="1000000">$1m</option>
            <option value="5000000">$5m</option>
          </select>
        </label>

        <label class="pill">
          <span>Sort by</span>
          <select id="fSort">
            <option value="volume">Vol 24h</option>
            <option value="liquidity">Liquidity</option>
            <option value="mcap">Mkt Cap</option>
            <option value="change">Change 24h</option>
            <option value="txns">TXNs 24h</option>
          </select>
        </label>

        <!-- EXCHANGE FILTERS -->
        <div class="dex-pills" id="dexPills" title="Filter by exchange (dexId)">
          <button class="chip small on" data-dexid="any">Any DEX</button>
          <button class="chip small" data-dexid="uniswap">Uniswap</button>
          <button class="chip small" data-dexid="sushiswap">Sushi</button>
          <button class="chip small" data-dexid="pancakeswap">Pancake</button>
          <button class="chip small" data-dexid="quickswap">QuickSwap</button>
          <button class="chip small" data-dexid="jupiter">Jupiter (SOL)</button>
        </div>

        <!-- SEARCH + GO (your red box) -->
        <div class="search">
          <input id="q" type="text" placeholder="Paste token address, pair URL, or type symbolâ€¦" />
          <button id="btnGo" class="btn">Go</button>
        </div>
      </div>

      <div class="hint muted">Multi-chain filters powered by Dexscreener. Click a tile to load the chart. â€œGoâ€ will run the filters and update the list below.</div>
    </section>

    <!-- CHART + FACTS -->
    <section class="grid">
      <div class="card chart">
        <div class="chart-head">
          <div class="title" id="pairTitle">Select a pair</div>
          <div class="venues" id="venueLinks"></div>
        </div>
        <iframe id="chart" title="Dexscreener Chart" loading="lazy" src="about:blank" allow="clipboard-write *"></iframe>
      </div>

      <div class="card facts">
        <div class="facts-head">
          <div>Pair Facts</div>
          <div class="sub" id="pairSub">â€”</div>
        </div>
        <div class="facts-grid">
          <div><span>Price</span><strong id="fPrice">â€”</strong></div>
          <div><span>24h Change</span><strong id="fChg">â€”</strong></div>
          <div><span>Liquidity</span><strong id="fLiqV">â€”</strong></div>
          <div><span>Mkt Cap</span><strong id="fCapV">â€”</strong></div>
          <div><span>Vol 24h</span><strong id="fVolV">â€”</strong></div>
          <div><span>TXNs (24h)</span><strong id="fTxV">â€”</strong></div>
        </div>
      </div>
    </section>

    <!-- MOVERS LIST (your green area) -->
    <section class="card movers">
      <div class="movers-head">
        <div class="title">Top Movers â€” filtered by your selections</div>
        <div class="muted">Click a tile to load the chart. Filters: chain + mode + (vol/liq/mcap) + exchange + sort.</div>
      </div>
      <div id="movers" class="movers-grid"></div>
      <div id="moversFoot" class="foot muted"></div>
    </section>
  </main>

  <footer class="dex-foot">DXLT v1.0 (scoped Dex page)</footer>

  <script>
  (function(){
    const $ = (s, root=document) => root.querySelector(s);
    const $$ = (s, root=document) => Array.from(root.querySelectorAll(s));

    // --- Elements
    const chains = $('#chains');
    const sentiment = $('#sentiment');
    const dexPills = $('#dexPills');
    const selectVol = $('#fVol');
    const selectLiq = $('#fLiq');
    const selectCap = $('#fCap');
    const selectSort = $('#fSort');
    const inputQ = $('#q');
    const btnGo = $('#btnGo');

    const moversGrid = $('#movers');
    const moversFoot = $('#moversFoot');
    const chart = $('#chart');
    const title = $('#pairTitle');
    const sub   = $('#pairSub');
    const venueLinks = $('#venueLinks');
    const facts = {
      price: $('#fPrice'),
      chg:   $('#fChg'),
      liq:   $('#fLiqV'),
      cap:   $('#fCapV'),
      vol:   $('#fVolV'),
      tx:    $('#fTxV'),
    };

    // --- State
    const S = {
      chain: 'all',
      mode: 'gainers',
      dexid: 'any',
      vol: 100000,
      liq: 100000,
      cap: 500000,
      sort: 'volume',
      movers: [],
      selected: null,
    };

    // --- Helpers
    const money = n => {
      const v = Number(n||0);
      if (!isFinite(v) || v<=0) return '$0';
      if (v >= 1e9) return '$' + (v/1e9).toFixed(2) + 'b';
      if (v >= 1e6) return '$' + (v/1e6).toFixed(2) + 'm';
      if (v >= 1e3) return '$' + (v/1e3).toFixed(1) + 'k';
      return '$' + v.toLocaleString();
    };
    const pct = x => ((Number(x)||0) > 0 ? '+' : '') + (Number(x)||0).toFixed(2) + '%';

    function chipBar(el, key){
      el.addEventListener('click', e=>{
        const b = e.target.closest('.chip'); if(!b) return;
        $$('.chip', el).forEach(x=>x.classList.toggle('on', x===b));
        S[key] = b.dataset.chain || b.dataset.mode || b.dataset.dexid || S[key];
        runFilters();
      });
    }
    chipBar(chains,'chain');
    chipBar(sentiment,'mode');
    chipBar(dexPills,'dexid');

    [selectVol,selectLiq,selectCap,selectSort].forEach(sel=>{
      sel.addEventListener('change', ()=>{
        S.vol  = Number(selectVol.value);
        S.liq  = Number(selectLiq.value);
        S.cap  = Number(selectCap.value);
        S.sort = selectSort.value;
        runFilters();
      });
    });

    btnGo.addEventListener('click', ()=> runFilters(inputQ.value.trim()));
    inputQ.addEventListener('keydown', e=>{ if(e.key==='Enter') runFilters(inputQ.value.trim()); });

    // --- API
    async function dexscreenerSearch(q='trending'){
      const url = `https://api.dexscreener.com/latest/dex/search?q=${encodeURIComponent(q)}`;
      const r = await fetch(url, {cache:'no-store'});
      if (!r.ok) throw new Error('dexsearch '+r.status);
      const j = await r.json();
      return j.pairs || [];
    }

    // small helper that gets some variety when not searching specifically
    async function seedPairs(){
      const buckets = ['trending','hot','new','gainers','losers'];
      const res = [];
      for (const k of buckets){
        try {
          const list = await dexscreenerSearch(k);
          res.push(...list.slice(0, 60)); // plenty to filter
        } catch(e){}
      }
      return res;
    }

    // --- Core filter pipeline
    function passChain(p){
      if (S.chain==='all') return true;
      return (String(p.chainId||'').toLowerCase()===S.chain.toLowerCase());
    }
    function passMode(p){
      if (S.mode==='new'){
        // under 24h age
        return (p.pairCreatedAt && (Date.now()-Number(p.pairCreatedAt)) < 24*3600*1000);
      }
      if (S.mode==='hot'){
        const tx = Number(p.txns?.h24?.buys||0)+Number(p.txns?.h24?.sells||0);
        return tx > 500; // arbitrary "hot"
      }
      if (S.mode==='gainers') return (Number(p.priceChange?.h24||0) > 0);
      if (S.mode==='losers')  return (Number(p.priceChange?.h24||0) < 0);
      return true;
    }
    function passDexId(p){
      if (S.dexid==='any') return true;
      return String(p.dexId||'').toLowerCase().includes(S.dexid.toLowerCase());
    }
    function passThresholds(p){
      const vol = Number(p.volume?.h24||0);
      const liq = Number(p.liquidity?.usd||0);
      const mc  = Number(p.fdv || p.marketCap || 0);
      return (vol>=S.vol && liq>=S.liq && mc>=S.cap);
    }
    function sorter(a,b){
      const m = {
        volume: (x)=>Number(x.volume?.h24||0),
        liquidity: (x)=>Number(x.liquidity?.usd||0),
        mcap: (x)=>Number(x.fdv||x.marketCap||0),
        change: (x)=>Number(x.priceChange?.h24||0),
        txns: (x)=>Number(x.txns?.h24?.buys||0)+Number(x.txns?.h24?.sells||0),
      }[S.sort];
      return (m(b)-m(a));
    }

    function renderMovers(list){
      if (!list.length){
        moversGrid.innerHTML = `<div class="placeholder">No matches. Try lowering thresholds or switching chain/mode.</div>`;
        moversFoot.textContent = '';
        return;
      }
      moversGrid.innerHTML = list.slice(0, 48).map(p=>{
        const ch = Number(p.priceChange?.h24||0);
        const logo = p.info?.imageUrl || p.baseToken?.logoURI || 'https://assets.dexscreener.com/favicon.png';
        const tx24 = Number(p.txns?.h24?.buys||0)+Number(p.txns?.h24?.sells||0);
        return `
          <div class="tile" data-chain="${p.chainId}" data-pair="${p.pairAddress}">
            <img src="${logo}" class="logo" alt="">
            <div class="meta">
              <div class="name">${p.baseToken?.symbol||'â€”'} / ${p.quoteToken?.symbol||'â€”'}</div>
              <div class="sub">${p.chainId} Â· ${p.dexId||''}</div>
            </div>
            <div class="right">
              <div class="chg ${ch>=0?'pos':'neg'}">${pct(ch)}</div>
              <div class="liqs">${money(p.liquidity?.usd)} liq Â· ${tx24.toLocaleString()} tx</div>
            </div>
          </div>`;
      }).join('');
      moversFoot.textContent = `${list.length.toLocaleString()} matches â€¢ Chain: ${S.chain} â€¢ Dex: ${S.dexid} â€¢ Volâ‰¥ ${money(S.vol)} â€¢ Liqâ‰¥ ${money(S.liq)} â€¢ Capâ‰¥ ${money(S.cap)}`;
    }

    function embedPair(p){
      if (!p) return;
      const src = `https://dexscreener.com/${p.chainId}/${p.pairAddress}?embed=1&theme=dark&trades=0`;
      chart.src = src;
      title.textContent = `${p.baseToken?.symbol||'â€”'}/${p.quoteToken?.symbol||'â€”'} â€¢ ${p.chainId}`;
      sub.textContent = p.pairAddress;

      facts.price.textContent = p.priceUsd ? ('$' + Number(p.priceUsd).toFixed(6)) : 'â€”';
      facts.chg.textContent   = p.priceChange?.h24!=null ? pct(p.priceChange.h24) : 'â€”';
      facts.liq.textContent   = money(p.liquidity?.usd);
      facts.cap.textContent   = money(p.fdv || p.marketCap);
      facts.vol.textContent   = money(p.volume?.h24);
      const tx24 = Number(p.txns?.h24?.buys||0)+Number(p.txns?.h24?.sells||0);
      facts.tx.textContent    = isFinite(tx24) ? tx24.toLocaleString() : 'â€”';

      // venues
      const links = [];
      links.push(`<a class="btn sm" target="_blank" rel="noopener" href="https://dexscreener.com/${p.chainId}/${p.pairAddress}">Dexscreener</a>`);
      if ((p.chainId==='ethereum'||p.chainId==='base'||p.chainId==='optimism'||p.chainId==='arbitrum') && p.baseToken?.address){
        links.push(`<a class="btn sm" target="_blank" rel="noopener" href="https://app.uniswap.org/explore/tokens/${p.chainId}/${p.baseToken.address}">Uniswap</a>`);
      }
      if (p.chainId==='arbitrum' && p.baseToken?.address){
        links.push(`<a class="btn sm" target="_blank" rel="noopener" href="https://www.sushi.com/swap?chainId=42161&tokenIn=${p.quoteToken?.address||''}&tokenOut=${p.baseToken.address}">Sushi</a>`);
      }
      if (p.chainId==='bsc' && p.baseToken?.address){
        links.push(`<a class="btn sm" target="_blank" rel="noopener" href="https://pancakeswap.finance/swap?outputCurrency=${p.baseToken.address}">Pancake</a>`);
      }
      if (p.chainId==='polygon' && p.baseToken?.address){
        links.push(`<a class="btn sm" target="_blank" rel="noopener" href="https://quickswap.exchange/#/swap?currency0=${p.baseToken.address}">QuickSwap</a>`);
      }
      if (p.chainId==='solana'){
        const t = p.baseToken?.address || p.baseToken?.symbol || '';
        links.push(`<a class="btn sm" target="_blank" rel="noopener" href="https://jup.ag/swap/${encodeURIComponent(t)}">Jupiter</a>`);
      }
      venueLinks.innerHTML = links.join('');
      S.selected = p;
    }

    moversGrid.addEventListener('click', e=>{
      const tile = e.target.closest('.tile'); if (!tile) return;
      const chain = tile.dataset.chain;
      const pair  = tile.dataset.pair;
      const p = (S.movers||[]).find(x=>x.chainId===chain && x.pairAddress===pair);
      if (p) embedPair(p);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // --- Run
    async function runFilters(q){
      try{
        let list;
        if (q) {
          list = await dexscreenerSearch(q);
        } else if (!S._seed) {
          S._seed = await seedPairs();
          list = S._seed.slice();
        } else {
          list = S._seed.slice();
        }

        // filter pipeline
        list = list
          .filter(passChain)
          .filter(passMode)
          .filter(passDexId)
          .filter(passThresholds)
          .sort(sorter);

        S.movers = list;
        renderMovers(list);

        // If nothing selected yet, embed top hit
        if (!S.selected && list[0]) embedPair(list[0]);
      }catch(e){
        console.warn(e);
        moversGrid.innerHTML = `<div class="placeholder">Unable to load list. Try again.</div>`;
      }
    }

    // initial
    runFilters();
  })();
  </script>
</body>
</html>





